
<% if segment_enabled? && @order.present? && !@order.burned %>
  <% order_json = SpreeAnalyticsTrackers::Segment::OrderPresenter.new(@order).to_json %>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      function getUserCookie(name) {
        var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
        if (match) {
          return decodeURIComponent(match[2]);
        } else {
          return '';
        }
      }

      if (typeof analytics !== 'undefined') {
        analytics.track('Order Completed',
          <%= order_json.html_safe %>,
          { email: (!!getUserCookie('user_email') ? getUserCookie('user_email') : '') },
          { integrations: { Friendbuy: { newCustomer: <%= @order.user&.orders&.complete&.count == 1  %> }} }
        );
      }

      function burnOrder() {
          fetch('/orders/<%= @order.number %>/burn', {
            method: 'POST'
          })
            .then(response => {
            if (!response.ok) {
            throw new Error('Network response was not ok');
          }
            return response.json();
          })
            .then(data => {
            console.log('Order marked as burned:', data);
          })
            .catch(error => {
            console.error('There was a problem with the fetch operation:', error);
          });
      }
      burnOrder();
    });
  </script>
<% end %>
